-- LISTAGG pivot + filter for Gender = Male and Lung Cancer = Positive
WITH agg AS (
  SELECT
    cf.patient_id,
    cf.facility_id,
    cf.form_record_id,
    -- LISTAGG each sub_category into a single string (pipe-separated)
    LISTAGG(CASE WHEN UPPER(TRIM(r.sub_category)) = 'GENDER' THEN TRIM(r.display_value) END, '|') 
      WITHIN GROUP (ORDER BY r.display_value) AS gender_vals,
    LISTAGG(CASE WHEN UPPER(TRIM(r.sub_category)) = 'LUNG CANCER' THEN TRIM(r.display_value) END, '|') 
      WITHIN GROUP (ORDER BY r.display_value) AS lung_cancer_vals
    -- add more LISTAGG(...) columns here for other subcategories if needed
  FROM rpt_case_fact cf
  JOIN report_fact r
    ON cf.form_record_id = r.form_record_id
  GROUP BY cf.patient_id, cf.facility_id, cf.form_record_id
)
SELECT patient_id, facility_id, form_record_id, gender_vals, lung_cancer_vals
FROM agg
WHERE
  -- check gender contains MALE or M (case-insensitive)
  (
    gender_vals IS NOT NULL
    AND (
      REGEXP_LIKE(UPPER(gender_vals), '(^|\\|)M(\\||$)')    -- matches 'M' as an item
      OR REGEXP_LIKE(UPPER(gender_vals), '(^|\\|)MALE(\\||$)')
    )
  )
  AND
  -- check lung cancer contains POSITIVE
  (
    lung_cancer_vals IS NOT NULL
    AND REGEXP_LIKE(UPPER(lung_cancer_vals), '(^|\\|)POSITIVE(\\||$)')
  );