WITH flat AS (
  SELECT
    c.patient_id,
    c.facility_id,
    c.form_record_id,
    MAX(CASE WHEN r.sub_category = 'ACUTE RESPIRATORY DISTRESS SYNDROME (ARDS)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ACUTE_RESPIRATORY_DISTRESS_SYNDROME__ARDS_",
    MAX(CASE WHEN r.sub_category = 'ADDITIONAL CHEST TUBE PLACEMENT  (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ADDITIONAL_CHEST_TUBE_PLACEMENT___DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'AGE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "AGE",
    MAX(CASE WHEN r.sub_category = 'AIR LEAK > 5 DAYS DURATION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "AIR_LEAK___5_DAYS_DURATION",
    MAX(CASE WHEN r.sub_category = 'ANASTOMOTIC LEAK REQUIRING MEDICAL TREATMENT ONLY (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ANASTOMOTIC_LEAK_REQUIRING_MEDICAL_TREATMENT_ONLY__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'ARE YOU COLLECTING DATA FOR HIATAL HERNIA / GERD?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ARE_YOU_COLLECTING_DATA_FOR_HIATAL_HERNIA___GERD_",
    MAX(CASE WHEN r.sub_category = 'ARE YOU COLLECTING DATA FOR THYMUS / MEDIASTINAL MASS RESECTION?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ARE_YOU_COLLECTING_DATA_FOR_THYMUS___MEDIASTINAL_MASS_RESECTION_",
    MAX(CASE WHEN r.sub_category = 'ARE YOU COLLECTING DATA FOR TRACHEAL RESECTION?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ARE_YOU_COLLECTING_DATA_FOR_TRACHEAL_RESECTION_",
    MAX(CASE WHEN r.sub_category = 'ASA CLASSIFICATION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ASA_CLASSIFICATION",
    MAX(CASE WHEN r.sub_category = 'ATELECTASIS REQ. BRONCHOSCOPY (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ATELECTASIS_REQ__BRONCHOSCOPY__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'ATRIAL ARRHYTHMIA REQUIRING TREATMENT' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ATRIAL_ARRHYTHMIA_REQUIRING_TREATMENT",
    MAX(CASE WHEN r.sub_category = 'BLOOD TRANSFUSION INTRAOPERATIVELY (PACKED RED BLOOD CELLS)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "BLOOD_TRANSFUSION_INTRAOPERATIVELY__PACKED_RED_BLOOD_CELLS_",
    MAX(CASE WHEN r.sub_category = 'BMI' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "BMI",
    MAX(CASE WHEN r.sub_category = 'BRAIN CT SCAN (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "BRAIN_CT_SCAN__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'BRAIN MRI (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "BRAIN_MRI__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'BRONCHOPLEURAL FISTULA' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "BRONCHOPLEURAL_FISTULA",
    MAX(CASE WHEN r.sub_category = 'BRONCHOSCOPY (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "BRONCHOSCOPY__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'CARDIOPULMONARY HISTORY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CARDIOPULMONARY_HISTORY",
    MAX(CASE WHEN r.sub_category = 'CENTRAL NEUROLOGICAL EVENT TYPE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CENTRAL_NEUROLOGICAL_EVENT_TYPE",
    MAX(CASE WHEN r.sub_category = 'CEPHALOSPORIN ANTIBIOTIC ORDERED  (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CEPHALOSPORIN_ANTIBIOTIC_ORDERED___DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'CEREBROVASCULAR HISTORY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CEREBROVASCULAR_HISTORY",
    MAX(CASE WHEN r.sub_category = 'CHRONIC ANTICOAGULATION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CHRONIC_ANTICOAGULATION",
    MAX(CASE WHEN r.sub_category = 'CHRONIC IMMUNOSUPPRESSIVE THERAPY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CHRONIC_IMMUNOSUPPRESSIVE_THERAPY",
    MAX(CASE WHEN r.sub_category = 'CIGARETTE SMOKING' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CIGARETTE_SMOKING",
    MAX(CASE WHEN r.sub_category = 'CLINICAL STAGING DONE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CLINICAL_STAGING_DONE",
    MAX(CASE WHEN r.sub_category = 'CLINICAL STAGING DONE (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CLINICAL_STAGING_DONE__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'CLOSTRIDIUM DIFFICILE INFECTION (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CLOSTRIDIUM_DIFFICILE_INFECTION__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'CONDUIT NECROSIS / FAILURE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CONDUIT_NECROSIS___FAILURE",
    MAX(CASE WHEN r.sub_category = 'CONDUIT NECROSIS REQUIRING SURGERY (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CONDUIT_NECROSIS_REQUIRING_SURGERY__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'CONGESTIVE HEART FAILURE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CONGESTIVE_HEART_FAILURE",
    MAX(CASE WHEN r.sub_category = 'CORONARY ARTERY DISEASE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CORONARY_ARTERY_DISEASE",
    MAX(CASE WHEN r.sub_category = 'CT (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "CT__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'DEEP VENOUS THROMBOSIS (DVT) REQ. TREATMENT' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DEEP_VENOUS_THROMBOSIS__DVT__REQ__TREATMENT",
    MAX(CASE WHEN r.sub_category = 'DELAYED CONDUIT EMPTYING REQUIRING INTERVENTION (PYLORI DILATATION OR BOTOX) OR MAINTENANCE OF NG DRAINAGE > 7 DAY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DELAYED_CONDUIT_EMPTYING_REQUIRING_INTERVENTION__PYLORI_DILATATION_OR_BOTOX__OR_MAINTENANCE_OF_NG_DRAINAGE___7_DAY",
    MAX(CASE WHEN r.sub_category = 'DIABETES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DIABETES",
    MAX(CASE WHEN r.sub_category = 'DILATION ESOPHAGUS (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DILATION_ESOPHAGUS__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'DISCHARGE LOCATION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DISCHARGE_LOCATION",
    MAX(CASE WHEN r.sub_category = 'DISCHARGE STATUS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DISCHARGE_STATUS",
    MAX(CASE WHEN r.sub_category = 'DISCHARGED ON ANTICOAGULATION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DISCHARGED_ON_ANTICOAGULATION",
    MAX(CASE WHEN r.sub_category = 'DISCHARGED ON DIALYSIS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DISCHARGED_ON_DIALYSIS",
    MAX(CASE WHEN r.sub_category = 'DISCHARGED WITH CHEST TUBE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DISCHARGED_WITH_CHEST_TUBE",
    MAX(CASE WHEN r.sub_category = 'DVT PROPHYLAXIS MEASURES (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "DVT_PROPHYLAXIS_MEASURES__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'EMPYEMA REQ. TREATMENT' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "EMPYEMA_REQ__TREATMENT",
    MAX(CASE WHEN r.sub_category = 'ENDOCRINE / GI / RENAL HISTORY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ENDOCRINE___GI___RENAL_HISTORY",
    MAX(CASE WHEN r.sub_category = 'ESOPH HISTOPATHOLOGIC TYPE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPH_HISTOPATHOLOGIC_TYPE",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGEAL CA HISTOLOGICAL GRADE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGEAL_CA_HISTOLOGICAL_GRADE",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGEAL CA METASTASES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGEAL_CA_METASTASES",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGEAL CA NODES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGEAL_CA_NODES",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGEAL CA RESECTION MARGINS POSITIVE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGEAL_CA_RESECTION_MARGINS_POSITIVE",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGEAL CANCER RESULTS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGEAL_CANCER_RESULTS",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGEAL CANCER RESULTS (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGEAL_CANCER_RESULTS__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGEAL TUMOR' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGEAL_TUMOR",
    MAX(CASE WHEN r.sub_category = 'ESOPHAGUS RESECTION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "ESOPHAGUS_RESECTION",
    MAX(CASE WHEN r.sub_category = 'EUS (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "EUS__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'GENDER' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "GENDER",
    MAX(CASE WHEN r.sub_category = 'GRADE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "GRADE",
    MAX(CASE WHEN r.sub_category = 'HIATAL HERNIA / GERD PROCEDURES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "HIATAL_HERNIA___GERD_PROCEDURES",
    MAX(CASE WHEN r.sub_category = 'HISPANIC OR LATINO ETHNICITY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "HISPANIC_OR_LATINO_ETHNICITY",
    MAX(CASE WHEN r.sub_category = 'HYPERTENSION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "HYPERTENSION",
    MAX(CASE WHEN r.sub_category = 'IF CANCER TUMOR PRESENT' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_CANCER_TUMOR_PRESENT",
    MAX(CASE WHEN r.sub_category = 'IF N2, MULTI-STATION N2 (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_N2__MULTI_STATION_N2__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'IF TUMOR IS T2A OR T2B' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_TUMOR_IS_T2A_OR_T2B",
    MAX(CASE WHEN r.sub_category = 'IF YES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_YES",
    MAX(CASE WHEN r.sub_category = 'IF YES, # UNITS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_YES____UNITS",
    MAX(CASE WHEN r.sub_category = 'IF YES, ANASTOMOTIC LEAK FOLLOWING ESOPHAGEAL SURGERY?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_YES__ANASTOMOTIC_LEAK_FOLLOWING_ESOPHAGEAL_SURGERY_",
    MAX(CASE WHEN r.sub_category = 'IF YES, CYCLOTHORAX PRESENT (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_YES__CYCLOTHORAX_PRESENT__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'IF YES, PRIMARY REASON FOR PROCEDURE:' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IF_YES__PRIMARY_REASON_FOR_PROCEDURE_",
    MAX(CASE WHEN r.sub_category = 'INITIAL VENT SUPPORT >48 HOURS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "INITIAL_VENT_SUPPORT__48_HOURS",
    MAX(CASE WHEN r.sub_category = 'IS THE PATIENT'S RACE DOCUMENTED?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IS_THE_PATIENT_S_RACE_DOCUMENTED_",
    MAX(CASE WHEN r.sub_category = 'IV ANTIBIOTICS GIVEN WITHIN 1 HOUR BEFORE INCISION (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IV_ANTIBIOTICS_GIVEN_WITHIN_1_HOUR_BEFORE_INCISION__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'IV ANTIBIOTICS ORDERED TO BE GIVEN WITHIN 1 HOUR BEFORE INCISION (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "IV_ANTIBIOTICS_ORDERED_TO_BE_GIVEN_WITHIN_1_HOUR_BEFORE_INCISION__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'LARYNGEAL NERVE PARESIS GRADE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LARYNGEAL_NERVE_PARESIS_GRADE",
    MAX(CASE WHEN r.sub_category = 'LARYNGEAL NERVE PARESIS SEVERITY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LARYNGEAL_NERVE_PARESIS_SEVERITY",
    MAX(CASE WHEN r.sub_category = 'LUNG CA HISTOLOGY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LUNG_CA_HISTOLOGY",
    MAX(CASE WHEN r.sub_category = 'LUNG CA METASTASES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LUNG_CA_METASTASES",
    MAX(CASE WHEN r.sub_category = 'LUNG CA NODES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LUNG_CA_NODES",
    MAX(CASE WHEN r.sub_category = 'LUNG CA RESECTION MARGINS POSITIVE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LUNG_CA_RESECTION_MARGINS_POSITIVE",
    MAX(CASE WHEN r.sub_category = 'LUNG CANCER RESECTION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LUNG_CANCER_RESECTION",
    MAX(CASE WHEN r.sub_category = 'LUNG CANCER RESULTS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "LUNG_CANCER_RESULTS",
    MAX(CASE WHEN r.sub_category = 'MYOCARDIAL INFARCT' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "MYOCARDIAL_INFARCT",
    MAX(CASE WHEN r.sub_category = 'MYOCARDIAL INFARCTION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "MYOCARDIAL_INFARCTION",
    MAX(CASE WHEN r.sub_category = 'NEW CENTRAL NEUROLOGICAL EVENT' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "NEW_CENTRAL_NEUROLOGICAL_EVENT",
    MAX(CASE WHEN r.sub_category = 'NEW RENAL FAILURE PER RIFLE CRITERIA' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "NEW_RENAL_FAILURE_PER_RIFLE_CRITERIA",
    MAX(CASE WHEN r.sub_category = 'NUMBER OF CASES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "NUMBER_OF_CASES",
    MAX(CASE WHEN r.sub_category = 'PACKED RED BLOOD CELLS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PACKED_RED_BLOOD_CELLS",
    MAX(CASE WHEN r.sub_category = 'PET OR PET/CT (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PET_OR_PET_CT__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'PLANNED, STAGED PROCEDURE?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PLANNED__STAGED_PROCEDURE_",
    MAX(CASE WHEN r.sub_category = 'PLEURAL EFFUSION REQ. DRAINAGE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PLEURAL_EFFUSION_REQ__DRAINAGE",
    MAX(CASE WHEN r.sub_category = 'PNEUMONIA' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PNEUMONIA",
    MAX(CASE WHEN r.sub_category = 'PNEUMOTHORAX REQ. CT' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PNEUMOTHORAX_REQ__CT",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE ANASTOMOTIC LEAK TYPE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_ANASTOMOTIC_LEAK_TYPE",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE CHYLE LEAK' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_CHYLE_LEAK",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE CHYLE LEAK GRADE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_CHYLE_LEAK_GRADE",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE CONDUIT NECROSIS TYPE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_CONDUIT_NECROSIS_TYPE",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE GRADE FOR ARDS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_GRADE_FOR_ARDS",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE GRADE FOR PNEUMONIA' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_GRADE_FOR_PNEUMONIA",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE GRADE MI' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_GRADE_MI",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE GRADE PULMONARY EMBOLUS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_GRADE_PULMONARY_EMBOLUS",
    MAX(CASE WHEN r.sub_category = 'POST OPERATIVE LENGTH OF STAY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POST_OPERATIVE_LENGTH_OF_STAY",
    MAX(CASE WHEN r.sub_category = 'POSTOPERATIVE EVENTS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "POSTOPERATIVE_EVENTS",
    MAX(CASE WHEN r.sub_category = 'PREOP MEDICATION HISTORY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PREOP_MEDICATION_HISTORY",
    MAX(CASE WHEN r.sub_category = 'PROPHYLACTIC ANTIBIOTIC DISCONTINUATION ORDERED WITHIN 24 HOUR (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PROPHYLACTIC_ANTIBIOTIC_DISCONTINUATION_ORDERED_WITHIN_24_HOUR__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'PULMONARY EMBOLUS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "PULMONARY_EMBOLUS",
    MAX(CASE WHEN r.sub_category = 'RACE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "RACE",
    MAX(CASE WHEN r.sub_category = 'RADIOGRAPHIC STAGING PROCEDURES' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "RADIOGRAPHIC_STAGING_PROCEDURES",
    MAX(CASE WHEN r.sub_category = 'RADIOLOGIC / ENDOSCOPIC STAGING PROCEDURE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "RADIOLOGIC___ENDOSCOPIC_STAGING_PROCEDURE",
    MAX(CASE WHEN r.sub_category = 'READMISSION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "READMISSION",
    MAX(CASE WHEN r.sub_category = 'READMISSION RELATED TO OPERATIVE PROCEDURE? (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "READMISSION_RELATED_TO_OPERATIVE_PROCEDURE___DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'READMIT TO ANY HOSPITAL WITHIN 30 DAYS OF DISCHARGE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "READMIT_TO_ANY_HOSPITAL_WITHIN_30_DAYS_OF_DISCHARGE",
    MAX(CASE WHEN r.sub_category = 'RECURRENT LARYNGEAL NERVE PARESIS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "RECURRENT_LARYNGEAL_NERVE_PARESIS",
    MAX(CASE WHEN r.sub_category = 'REOPERATION (ANY PRIOR CARDIOTHORACIC SURGERY THAT AFFECTS OPERATIVE FIELD)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "REOPERATION__ANY_PRIOR_CARDIOTHORACIC_SURGERY_THAT_AFFECTS_OPERATIVE_FIELD_",
    MAX(CASE WHEN r.sub_category = 'RESPIRATORY FAILURE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "RESPIRATORY_FAILURE",
    MAX(CASE WHEN r.sub_category = 'SEPSIS' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "SEPSIS",
    MAX(CASE WHEN r.sub_category = 'SMOKING CESSATION COUNSELING (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "SMOKING_CESSATION_COUNSELING__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'STATUS AT 30 DAYS AFTER SURGERY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "STATUS_AT_30_DAYS_AFTER_SURGERY",
    MAX(CASE WHEN r.sub_category = 'STATUS OF OPERATION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "STATUS_OF_OPERATION",
    MAX(CASE WHEN r.sub_category = 'STENT PLACEMENT (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "STENT_PLACEMENT__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'SUBSTANCE USE SCREENING AND COUNSELING' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "SUBSTANCE_USE_SCREENING_AND_COUNSELING",
    MAX(CASE WHEN r.sub_category = 'SURGICAL DRAINAGE AND REPAIR (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "SURGICAL_DRAINAGE_AND_REPAIR__DISCONTINUED_WITH_V5_21_1_",
    MAX(CASE WHEN r.sub_category = 'SURGICAL PROCEDURE FOR ESOPHAGEAL CANCER?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "SURGICAL_PROCEDURE_FOR_ESOPHAGEAL_CANCER_",
    MAX(CASE WHEN r.sub_category = 'SURGICAL PROCEDURE FOR LUNG CANCER OR SUSPECTED LUNG CANCER?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "SURGICAL_PROCEDURE_FOR_LUNG_CANCER_OR_SUSPECTED_LUNG_CANCER_",
    MAX(CASE WHEN r.sub_category = 'SURGICAL SITE INFECTION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "SURGICAL_SITE_INFECTION",
    MAX(CASE WHEN r.sub_category = 'THYMUS / MEDIASTINAL MASS RESECTION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "THYMUS___MEDIASTINAL_MASS_RESECTION",
    MAX(CASE WHEN r.sub_category = 'TRACHEAL RESECTION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "TRACHEAL_RESECTION",
    MAX(CASE WHEN r.sub_category = 'TRACHEOSTOMY' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "TRACHEOSTOMY",
    MAX(CASE WHEN r.sub_category = 'UNANTICIPATED POST-OPERATIVE INVASIVE PROCEDURE?' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "UNANTICIPATED_POST_OPERATIVE_INVASIVE_PROCEDURE_",
    MAX(CASE WHEN r.sub_category = 'UNANTICIPATED SURGICAL APPROACH CONVERSION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "UNANTICIPATED_SURGICAL_APPROACH_CONVERSION",
    MAX(CASE WHEN r.sub_category = 'UNANTICIPATED SURGICAL APPROACH CONVERSION REASON' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "UNANTICIPATED_SURGICAL_APPROACH_CONVERSION_REASON",
    MAX(CASE WHEN r.sub_category = 'UNANTICIPATED SURGICAL APPROACH CONVERSION TYPE' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "UNANTICIPATED_SURGICAL_APPROACH_CONVERSION_TYPE",
    MAX(CASE WHEN r.sub_category = 'URINARY TRACT INFECTION' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "URINARY_TRACT_INFECTION",
    MAX(CASE WHEN r.sub_category = 'WAS THERE A PATHOLOGICAL DIAGNOSIS OF LUNG CANCER PRIOR TO THE LUNG RESECTION? (DISCONTINUED WITH V5.21.1)' THEN LISTAGG(r.display_value, '|') WITHIN GROUP (ORDER BY r.display_value) END) AS "WAS_THERE_A_PATHOLOGICAL_DIAGNOSIS_OF_LUNG_CANCER_PRIOR_TO_THE_LUNG_RESECTION___DISCONTINUED_WITH_V5_21_1_"
  FROM rpt_case_fact c
  JOIN rpt_report_fact r ON c.calculation_id = r.calculation_id
  JOIN SUBCATEGORIES s ON r.sub_category = s.sub_category
  GROUP BY c.patient_id, c.facility_id, c.form_record_id
) SELECT * FROM flat;
